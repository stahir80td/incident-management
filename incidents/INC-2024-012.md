---
incident_id: INC-2024-012
severity: critical
service: inventory-management
date: 2024-04-09
---

# Database Deadlock Storm in Inventory System

## Summary
Inventory management system experienced hundreds of database deadlocks per minute, causing transaction failures and inventory count inaccuracies during flash sale event.

## Impact
- 4,670 failed transactions
- Inventory counts became inconsistent
- Flash sale extended by 30 minutes due to issues
- Manual inventory reconciliation required
- Duration: 28 minutes until mitigation

## Timeline
- 18:00 UTC: Flash sale began
- 18:03 UTC: Deadlock errors started appearing
- 18:05 UTC: Transaction failure rate at 15%
- 18:07 UTC: On-call engineer alerted
- 18:15 UTC: Identified conflicting transaction patterns
- 18:20 UTC: Implemented query-level locking hints
- 18:28 UTC: Deadlock rate dropped to normal levels
- 19:30 UTC: Completed inventory reconciliation

## Root Cause
Two concurrent processes were updating inventory in opposite order: the reservation system locked rows by product_id ascending, while the fulfillment system locked by warehouse_id ascending. Under high load during the flash sale, this created circular wait conditions.

## Resolution
1. Immediately applied query hints to force consistent lock ordering
2. Modified both systems to lock by product_id ascending
3. Implemented row-level locking with NOWAIT
4. Added deadlock retry logic with exponential backoff
5. Ran inventory reconciliation script

## Prevention
- Establish consistent locking order standard across all services
- Implement deadlock rate monitoring and alerting
- Add load testing with concurrent updates to test suite
- Create database locking guidelines documentation
- Require database transaction review for high-concurrency paths
- Add circuit breaker for high deadlock scenarios
