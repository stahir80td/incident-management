---
incident_id: INC-2024-006
severity: medium
service: order-fulfillment
date: 2024-02-25
---

# Kafka Consumer Lag in Order Fulfillment

## Summary
Order fulfillment service experienced significant consumer lag on the orders topic, delaying order processing by up to 4 hours during peak period.

## Impact
- 1,847 orders delayed beyond SLA
- Customer complaints increased 340%
- Fulfillment team worked overtime to catch up
- Duration: 6 hours until lag cleared

## Timeline
- 10:30 UTC: Consumer lag alerts triggered at 50K messages
- 10:45 UTC: Lag continued growing to 200K messages
- 11:00 UTC: On-call engineer investigated consumer group
- 11:30 UTC: Identified slow message processing in new code path
- 12:15 UTC: Scaled consumers from 3 to 12 instances
- 14:00 UTC: Optimized slow database query
- 16:30 UTC: Lag fully cleared

## Root Cause
A recent deployment introduced a synchronous database call inside the message processing loop. This call took 2-3 seconds per message, reducing throughput from 500 msg/sec to 30 msg/sec. During peak order volume, the consumer could not keep pace.

## Resolution
1. Immediately scaled consumer instances horizontally
2. Refactored database call to async batch operation
3. Added connection pooling to database client
4. Implemented message processing timeout
5. Deployed optimized version

## Prevention
- Mandate performance testing for Kafka consumer changes
- Implement consumer lag alerting at 10K, 50K, 100K thresholds
- Add message processing duration metrics
- Create consumer scaling playbook
- Require async patterns for I/O operations in consumers
- Add throughput testing to CI/CD pipeline
