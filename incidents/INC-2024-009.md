---
incident_id: INC-2024-009
severity: high
service: recommendation-engine
date: 2024-03-19
---

# Kubernetes Node Failure and Pod Scheduling Issue

## Summary
A Kubernetes node experienced hardware failure, and anti-affinity rules prevented pods from rescheduling on remaining nodes, causing service degradation.

## Impact
- Recommendation engine capacity reduced by 40%
- 25% of users received fallback generic recommendations
- Revenue impact: ~$8,200 in reduced conversion
- Duration: 3 hours 45 minutes

## Timeline
- 11:20 UTC: K8s node node-7 marked as NotReady
- 11:25 UTC: Pods terminating but not rescheduling
- 11:30 UTC: Capacity alerts triggered
- 11:35 UTC: On-call engineer investigating
- 12:00 UTC: Identified anti-affinity constraint issue
- 12:30 UTC: Temporarily relaxed pod affinity rules
- 13:15 UTC: New node provisioned and joined cluster
- 15:05 UTC: Full capacity restored with proper affinity

## Root Cause
The recommendation engine had strict anti-affinity rules requiring pods to be on separate nodes. With only 5 nodes in the cluster and 8 replicas configured, the scheduler could not place all pods when node-7 failed.

## Resolution
1. Temporarily changed anti-affinity from required to preferred
2. Provisioned additional cluster node
3. Reduced replica count from 8 to 5 as temporary measure
4. Expanded cluster from 5 to 7 nodes total
5. Restored original anti-affinity rules

## Prevention
- Review pod topology spread constraints across all services
- Implement cluster capacity planning with N+2 redundancy
- Set up alerts for pod scheduling failures
- Create runbook for node failure scenarios
- Add automated node replacement workflow
- Conduct quarterly cluster capacity reviews
